#!/usr/bin/env bash
set -e

# ------------------------------------------------------------------------
# java -jar mdl.jar src/dsktest-v0.asm -bin dsktest.bin -asm+:html dsktest.html -st dsktest.sym 
java -jar mdl.jar src/dsktest.asm -bin dsktest.bin -asm+:html dsktest.html -st dsktest.sym 
java -jar mdl.jar src/readfile.asm -bin readfile.bin -asm+:html readfile.html -st readfile.sym

# Memory usage stats:
read_from_symbol_file () {
	# Read the value of a label from the symbol file generated by MDL.
	value="$(grep "$1" "$2" | cut -d ' ' -f3- | cut -c3-)"
	valuedec="$(echo $((16#$value)))"
	echo $valuedec
}

STARTDSK=$(read_from_symbol_file "paketdsk_start_of_paketdsk:" dsktest.sym)
ENDDSK=$(read_from_symbol_file "paketdsk_end_of_paketdsk" dsktest.sym)
STARTDSKRAM=$(read_from_symbol_file "paketdsk_start_of_ram_paketdsk:" dsktest.sym)
ENDDSKRAM=$(read_from_symbol_file "paketdsk_end_of_ram_paketdsk" dsktest.sym)
USEDBIN=$((ENDDSK-STARTDSK))
USEDRAM=$((ENDDSKRAM-STARTDSKRAM))
USED=$((USEDBIN+USEDRAM))

echo "PAKETDSK v1: used bin: ${USEDBIN}, used ram: ${USEDRAM}, total: ${USED}"


# If you have the iDSK tool, you can create a disk with these two files like this:
./iDSK dsktest.dsk -n -i dsktest.bin -e 4000 -c 4000 -t 1
./iDSK dsktest.dsk -i readfile.bin -e 4000 -c 4000 -t 1
